"""
Utilitaires de chiffrement pour donn√©es sensibles.
Utilise Fernet (AES 128-bit CBC) pour le chiffrement sym√©trique.
"""

import os
import base64
from cryptography.fernet import Fernet
from cryptography.hazmat.primitives import hashes
from cryptography.hazmat.primitives.kdf.pbkdf2 import PBKDF2HMAC

from .logging import get_logger

logger = get_logger(__name__)


def get_encryption_key() -> bytes:
    """
    R√©cup√®re la cl√© de chiffrement depuis l'environnement.

    SECURITY CRITICAL: Fails fast if AUTH_ENCRYPTION_KEY is not set or invalid.
    This prevents falling back to a predictable/compromised key.

    Returns:
        Cl√© Fernet (32 bytes base64-encoded)

    Raises:
        RuntimeError: Si la cl√© n'est pas d√©finie
        ValueError: Si la cl√© a un format invalide

    Note:
        La cl√© DOIT √™tre d√©finie dans AUTH_ENCRYPTION_KEY (environnement).
        G√©n√©rer avec: python -m src.utils.encryption
    """
    # Lire depuis environnement
    key_b64 = os.getenv("AUTH_ENCRYPTION_KEY")

    if not key_b64:
        logger.critical(
            "‚ùå FATAL: AUTH_ENCRYPTION_KEY environment variable is NOT SET!\n"
            "   This is required to encrypt LinkedIn credentials securely.\n"
            "   \n"
            "   HOW TO FIX:\n"
            "   1. Generate a secure key: python -m src.utils.encryption\n"
            "   2. Copy the output: AUTH_ENCRYPTION_KEY=...\n"
            "   3. Add to your .env file or container environment\n"
            "   4. Restart the application\n"
        )
        raise RuntimeError(
            "AUTH_ENCRYPTION_KEY environment variable is REQUIRED and NOT SET. "
            "Please run: python -m src.utils.encryption to generate a secure key."
        )

    try:
        # Validate it's a proper Fernet key (44 chars base64)
        # This will raise InvalidToken if not a valid Fernet key
        Fernet(key_b64.encode('utf-8'))
        logger.info("‚úÖ AUTH_ENCRYPTION_KEY validated successfully")
        return key_b64.encode('utf-8')
    except Exception as e:
        logger.error(f"‚ùå Invalid AUTH_ENCRYPTION_KEY format: {e}")
        logger.error("   Key must be a 44-character base64 string generated by Fernet.generate_key()")
        raise ValueError(
            f"AUTH_ENCRYPTION_KEY has invalid format. Error: {str(e)}\n"
            f"   Please run: python -m src.utils.encryption to generate a valid key."
        )


def encrypt_json(data: dict) -> str:
    """
    Chiffre un dictionnaire JSON et retourne une string base64.

    Args:
        data: Dictionnaire √† chiffrer

    Returns:
        String base64 du contenu chiffr√©

    Raises:
        Exception: Si le chiffrement √©choue
    """
    import json

    key = get_encryption_key()
    fernet = Fernet(key)

    # S√©rialiser JSON (compact pour r√©duire taille)
    json_bytes = json.dumps(data, separators=(',', ':')).encode('utf-8')

    # Chiffrer
    encrypted_bytes = fernet.encrypt(json_bytes)

    # Encoder en base64 pour stockage
    return base64.b64encode(encrypted_bytes).decode('utf-8')


def decrypt_json(encrypted_b64: str) -> dict:
    """
    D√©chiffre une string base64 et retourne un dictionnaire JSON.

    Args:
        encrypted_b64: String base64 du contenu chiffr√©

    Returns:
        Dictionnaire d√©chiffr√©

    Raises:
        InvalidToken: Si le d√©chiffrement √©choue (cl√© invalide ou donn√©es corrompues)
        Exception: Si le parsing JSON √©choue
    """
    import json

    key = get_encryption_key()
    fernet = Fernet(key)

    # D√©coder base64
    encrypted_bytes = base64.b64decode(encrypted_b64)

    # D√©chiffrer (l√®ve InvalidToken si la cl√© est mauvaise)
    decrypted_bytes = fernet.decrypt(encrypted_bytes)

    # Parser JSON
    return json.loads(decrypted_bytes.decode('utf-8'))


def generate_new_key() -> str:
    """
    G√©n√®re une nouvelle cl√© Fernet al√©atoire s√©curis√©e.

    Returns:
        Cl√© Fernet encod√©e en base64 (44 caract√®res)

    Usage:
        >>> from src.utils.encryption import generate_new_key
        >>> new_key = generate_new_key()
        >>> print(f"Add this to your .env: AUTH_ENCRYPTION_KEY={new_key}")
    """
    return Fernet.generate_key().decode('utf-8')


if __name__ == "__main__":
    # Test du module
    logger.info("üîê Encryption Module Test")
    logger.info("=" * 50)

    # G√©n√©rer une nouvelle cl√©
    new_key = generate_new_key()
    logger.info(f"\n‚úÖ New encryption key generated:")
    logger.info(f"AUTH_ENCRYPTION_KEY={new_key}")
    logger.warning(f"\n‚ö†Ô∏è  Add this to your .env file!")

    # Test chiffrement/d√©chiffrement
    logger.info("\n" + "=" * 50)
    logger.info("Testing encryption/decryption...")

    test_data = {
        "cookies": [
            {"name": "li_at", "value": "test_session_token_12345"},
            {"name": "JSESSIONID", "value": "ajax:1234567890"}
        ],
        "origins": ["https://www.linkedin.com"]
    }

    try:
        # Chiffrer
        encrypted = encrypt_json(test_data)
        logger.info(f"‚úÖ Encrypted (first 50 chars): {encrypted[:50]}...")

        # D√©chiffrer
        decrypted = decrypt_json(encrypted)
        logger.info(f"‚úÖ Decrypted successfully")
        logger.info(f"   Cookies count: {len(decrypted.get('cookies', []))}")

        # V√©rifier int√©grit√©
        assert decrypted == test_data, "Data mismatch!"
        logger.info(f"‚úÖ Data integrity verified")

    except Exception as e:
        logger.error(f"‚ùå Error: {e}")

    logger.info("\n" + "=" * 50)
    logger.info("‚úÖ All tests passed!")
