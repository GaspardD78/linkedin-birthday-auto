{% extends "base.html" %}

{% block title %}Dashboard - LinkedIn Birthday Auto{% endblock %}

{% block extra_css %}
<style>
    .stat-card {
        transition: transform 0.2s;
    }
    .stat-card:hover {
        transform: translateY(-2px);
    }
    .stat-icon {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 10px;
        font-size: 1.2rem;
    }
    .stat-icon.primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .stat-icon.success { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
    .stat-icon.info { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .stat-icon.danger { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }

    .log-terminal {
        background-color: #1e1e1e;
        color: #d4d4d4;
        font-family: 'Consolas', 'Monaco', monospace;
        font-size: 0.8rem;
        height: 300px;
        overflow-y: auto;
        padding: 10px;
        border-radius: 5px;
        white-space: pre-wrap;
    }

    .status-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 5px;
    }

    .status-running { background-color: #28a745; box-shadow: 0 0 5px #28a745; }
    .status-stopped { background-color: #dc3545; }

    .compact-list-item {
        padding: 0.5rem !important;
        font-size: 0.9rem;
    }

    .chart-container-sm {
        height: 220px;
        position: relative;
    }
</style>
{% endblock %}

{% block content %}
<!-- Header Compact -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h4 class="fw-bold mb-0"><i class="bi bi-speedometer2 text-primary"></i> Dashboard</h4>
        <small class="text-muted">Vue d'ensemble et contrôle</small>
    </div>
    <div class="d-flex gap-2 align-items-center">
        <div class="form-check form-switch me-2">
            <input class="form-check-input" type="checkbox" id="autoRefresh" checked>
            <label class="form-check-label small" for="autoRefresh">Auto-refresh</label>
        </div>
        <button class="btn btn-sm btn-outline-primary" onclick="refreshDashboard()" id="refreshBtn">
            <i class="fas fa-sync-alt"></i>
        </button>
    </div>
</div>

<!-- Row 1: Stats Compactes -->
<div class="row g-3 mb-3">
    <div class="col-6 col-md-3">
        <div class="card stat-card border-0 shadow-sm h-100">
            <div class="card-body p-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="text-muted small text-uppercase fw-bold">Messages</div>
                        <div class="h4 mb-0 fw-bold" id="stat-messages">{{ stats_30d.messages.total }}</div>
                    </div>
                    <div class="stat-icon primary text-white">
                        <i class="fas fa-paper-plane"></i>
                    </div>
                </div>
                <div class="mt-2 small">
                    <span class="badge bg-warning text-dark" id="stat-late-badge" {% if stats_30d.messages.late == 0 %}style="display:none"{% endif %}>
                        <i class="fas fa-clock"></i> <span id="stat-late">{{ stats_30d.messages.late }}</span> retard
                    </span>
                </div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card stat-card border-0 shadow-sm h-100">
            <div class="card-body p-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="text-muted small text-uppercase fw-bold">Visites</div>
                        <div class="h4 mb-0 fw-bold" id="stat-visits">{{ stats_30d.profile_visits.total }}</div>
                    </div>
                    <div class="stat-icon success text-white">
                        <i class="fas fa-user-check"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card stat-card border-0 shadow-sm h-100">
            <div class="card-body p-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="text-muted small text-uppercase fw-bold">Contacts</div>
                        <div class="h4 mb-0 fw-bold" id="stat-contacts">{{ stats_30d.contacts.unique }}</div>
                    </div>
                    <div class="stat-icon info text-white">
                        <i class="fas fa-users"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card stat-card border-0 shadow-sm h-100">
            <div class="card-body p-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="text-muted small text-uppercase fw-bold">Erreurs</div>
                        <div class="h4 mb-0 fw-bold text-danger" id="stat-errors">{{ stats_30d.errors.total }}</div>
                    </div>
                    <div class="stat-icon danger text-white">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Row 2: Main Grid -->
<div class="row g-3">
    <!-- Left Column: Activity & Logs -->
    <div class="col-lg-8">
        <!-- Activity Chart -->
        <div class="card border-0 shadow-sm mb-3">
            <div class="card-header bg-white border-0 py-2 d-flex justify-content-between align-items-center">
                <h6 class="fw-bold mb-0"><i class="fas fa-chart-line text-primary me-2"></i>Activité (7j)</h6>
            </div>
            <div class="card-body p-2">
                <div class="chart-container-sm">
                    <canvas id="activityChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Real-time Logs -->
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 py-2 d-flex justify-content-between align-items-center">
                <h6 class="fw-bold mb-0"><i class="fas fa-terminal text-dark me-2"></i>Logs en direct</h6>
                <select class="form-select form-select-sm w-auto" id="log-selector" onchange="updateLogs()">
                    <option value="birthday">Messages</option>
                    <option value="visit">Visites</option>
                    <option value="system">Système</option>
                </select>
            </div>
            <div class="card-body p-0">
                <div id="log-terminal" class="log-terminal mx-2 mb-2">Chargement des logs...</div>
            </div>
        </div>
    </div>

    <!-- Right Column: Controls & Lists -->
    <div class="col-lg-4">
        <!-- Control Panel -->
        <div class="card border-0 shadow-sm mb-3">
            <div class="card-header bg-white border-0 py-2">
                <h6 class="fw-bold mb-0"><i class="fas fa-power-off text-danger me-2"></i>Contrôle</h6>
            </div>
            <div class="card-body p-3">
                <!-- Script Messages -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <span class="status-indicator status-stopped" id="status-msg"></span>
                        <span class="fw-semibold small">Anniversaires</span>
                    </div>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-success" onclick="controlScript('start', 'linkedin_birthday_wisher.py')"><i class="fas fa-play"></i></button>
                        <button class="btn btn-outline-danger" onclick="controlScript('stop', 'linkedin_birthday_wisher.py')"><i class="fas fa-stop"></i></button>
                    </div>
                </div>
                <!-- Script Visits -->
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <span class="status-indicator status-stopped" id="status-visit"></span>
                        <span class="fw-semibold small">Visites</span>
                    </div>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-success" onclick="controlScript('start', 'visit_profiles.py')"><i class="fas fa-play"></i></button>
                        <button class="btn btn-outline-danger" onclick="controlScript('stop', 'visit_profiles.py')"><i class="fas fa-stop"></i></button>
                    </div>
                </div>

                <hr class="my-2">

                <!-- System Stats -->
                <div class="row text-center small text-muted">
                    <div class="col-6">
                        <i class="fas fa-microchip"></i> CPU: <span id="sys-cpu">0%</span>
                    </div>
                    <div class="col-6">
                        <i class="fas fa-memory"></i> RAM: <span id="sys-ram">0%</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Weekly Limit -->
        <div class="card border-0 shadow-sm mb-3">
            <div class="card-body p-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <small class="fw-bold text-uppercase text-muted">Limite Hebdo</small>
                    <span class="badge bg-light text-dark border" id="weekly-limit-text">
                        {{ weekly_count }} / {{ weekly_limit }}
                    </span>
                </div>
                <div class="progress" style="height: 8px;">
                    {% set percentage = (weekly_count / weekly_limit * 100) | int %}
                    <div id="weekly-progress" class="progress-bar {% if percentage >= 90 %}bg-danger{% elif percentage >= 70 %}bg-warning{% else %}bg-success{% endif %}"
                         role="progressbar"
                         style="width: {{ percentage }}%">
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs for Lists -->
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white border-0 p-0">
                <ul class="nav nav-tabs nav-fill" id="myTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active small py-2" id="contacts-tab" data-bs-toggle="tab" data-bs-target="#contacts" type="button">Top Contacts</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link small py-2" id="errors-tab" data-bs-toggle="tab" data-bs-target="#errors" type="button">Erreurs</button>
                    </li>
                </ul>
            </div>
            <div class="card-body p-0" style="max-height: 300px; overflow-y: auto;">
                <div class="tab-content" id="myTabContent">
                    <!-- Top Contacts -->
                    <div class="tab-pane fade show active" id="contacts" role="tabpanel">
                        <div class="list-group list-group-flush" id="top-contacts-list">
                            {% for contact in top_contacts %}
                            <div class="list-group-item compact-list-item d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center text-truncate">
                                    <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center small me-2" style="width: 25px; height: 25px; font-size: 0.7rem;">
                                        {{ contact.name[0] }}
                                    </div>
                                    <span class="text-truncate" style="max-width: 120px;" title="{{ contact.name }}">{{ contact.name }}</span>
                                </div>
                                <span class="badge bg-light text-dark border rounded-pill">{{ contact.message_count }}</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <!-- Recent Errors -->
                    <div class="tab-pane fade" id="errors" role="tabpanel">
                        <div class="list-group list-group-flush" id="recent-errors-list">
                            {% for error in recent_errors[:5] %}
                            <div class="list-group-item compact-list-item">
                                <div class="d-flex justify-content-between">
                                    <small class="text-danger fw-bold">{{ error.error_type }}</small>
                                    <small class="text-muted" style="font-size: 0.7rem">{{ error.occurred_at|time_ago }}</small>
                                </div>
                                <div class="text-truncate small text-muted" title="{{ error.error_message }}">{{ error.error_message }}</div>
                            </div>
                            {% else %}
                            <div class="p-3 text-center text-muted small">Aucune erreur récente</div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    // Configuration
    let chartInstance = null;
    let refreshInterval = null;

    // Init
    document.addEventListener('DOMContentLoaded', function() {
        initChart();
        startAutoRefresh();
        updateLogs();

        // Toggle Auto-refresh
        document.getElementById('autoRefresh').addEventListener('change', function(e) {
            if(e.target.checked) {
                startAutoRefresh();
            } else {
                stopAutoRefresh();
            }
        });
    });

    function startAutoRefresh() {
        if(refreshInterval) clearInterval(refreshInterval);
        refreshDashboard(); // Immediate update
        refreshInterval = setInterval(refreshDashboard, 10000); // Every 10s
    }

    function stopAutoRefresh() {
        if(refreshInterval) clearInterval(refreshInterval);
    }

    // Dashboard Refresh Logic
    function refreshDashboard() {
        const btn = document.getElementById('refreshBtn');
        const icon = btn.querySelector('i');
        icon.classList.add('fa-spin');

        Promise.all([
            fetch('/api/stats/30').then(r => r.json()),
            fetch('/api/system_status').then(r => r.json()),
            fetch('/api/weekly-count').then(r => r.json()),
            updateLogs()
        ]).then(([stats, status, weekly]) => {
            updateStatsUI(stats);
            updateStatusUI(status);
            updateWeeklyUI(weekly);
        }).catch(err => console.error('Dashboard refresh error:', err))
        .finally(() => {
            icon.classList.remove('fa-spin');
        });
    }

    // UI Updaters
    function updateStatsUI(stats) {
        document.getElementById('stat-messages').textContent = stats.messages.total;
        document.getElementById('stat-visits').textContent = stats.profile_visits.total;
        document.getElementById('stat-contacts').textContent = stats.contacts.unique;
        document.getElementById('stat-errors').textContent = stats.errors.total;

        const lateBadge = document.getElementById('stat-late-badge');
        if(stats.messages.late > 0) {
            lateBadge.style.display = 'inline-block';
            document.getElementById('stat-late').textContent = stats.messages.late;
        } else {
            lateBadge.style.display = 'none';
        }
    }

    function updateStatusUI(data) {
        // Scripts
        setScriptStatus('status-msg', data.scripts.birthday_wisher);
        setScriptStatus('status-visit', data.scripts.visit_profiles);

        // System
        document.getElementById('sys-cpu').textContent = data.system.cpu + '%';
        document.getElementById('sys-ram').textContent = data.system.memory + '%';
    }

    function setScriptStatus(id, isRunning) {
        const el = document.getElementById(id);
        el.className = 'status-indicator ' + (isRunning ? 'status-running' : 'status-stopped');
    }

    function updateWeeklyUI(data) {
        document.getElementById('weekly-limit-text').textContent = `${data.count} / ${data.limit}`;
        const bar = document.getElementById('weekly-progress');
        bar.style.width = data.percentage + '%';

        bar.className = 'progress-bar ' +
            (data.percentage >= 90 ? 'bg-danger' :
             data.percentage >= 70 ? 'bg-warning' : 'bg-success');
    }

    function updateLogs() {
        const type = document.getElementById('log-selector').value;
        return fetch(`/api/logs/content?type=${type}&lines=50`)
            .then(r => r.json())
            .then(data => {
                const terminal = document.getElementById('log-terminal');
                terminal.textContent = data.lines.join('');
                terminal.scrollTop = terminal.scrollHeight;
            });
    }

    // Script Control
    function controlScript(action, scriptName) {
        if(!confirm(`Êtes-vous sûr de vouloir ${action === 'start' ? 'démarrer' : 'arrêter'} ${scriptName} ?`)) return;

        fetch(`/api/control/${action}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({script: scriptName, pid: 0}) // PID handled by backend for stop if needed, or we should fetch it
        })
        .then(r => r.json())
        .then(data => {
            if(data.success) {
                // Force refresh status
                fetch('/api/system_status').then(r => r.json()).then(updateStatusUI);
                alert(data.message);
            } else {
                alert('Erreur: ' + data.message);
            }
        });
    }

    // Chart
    function initChart() {
        const ctx = document.getElementById('activityChart');
        if (!ctx) return;

        // Initial data from template render (fallback)
        {% if daily_activity %}
        const initialLabels = [{% for day in daily_activity[:7]|reverse %}'{{ day.date }}',{% endfor %}];
        const initialMsg = [{% for day in daily_activity[:7]|reverse %}{{ day.messages }},{% endfor %}];
        const initialVisit = [{% for day in daily_activity[:7]|reverse %}{{ day.visits }},{% endfor %}];
        {% else %}
        const initialLabels = [];
        const initialMsg = [];
        const initialVisit = [];
        {% endif %}

        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: initialLabels,
                datasets: [
                    {
                        label: 'Messages',
                        data: initialMsg,
                        borderColor: 'rgb(102, 126, 234)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 2,
                        pointRadius: 2
                    },
                    {
                        label: 'Visites',
                        data: initialVisit,
                        borderColor: 'rgb(17, 153, 142)',
                        backgroundColor: 'rgba(17, 153, 142, 0.1)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 2,
                        pointRadius: 2
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: true, position: 'top', labels: { boxWidth: 10, font: { size: 10 } } },
                    tooltip: { mode: 'index', intersect: false }
                },
                scales: {
                    y: { beginAtZero: true, ticks: { precision: 0 } },
                    x: { grid: { display: false } }
                }
            }
        });
    }
</script>
{% endblock %}
